import{_ as L}from"./plugin-vue_export-helper.f9bdc015.js";import{I as $,h as g,t as V,i as u,r as C,c as h,d as r,n as p,w as m,j as k,e as y,v as _,k as z,m as b,q as w,s as I,a as v,o as c,u as f,x as D,p as A,b as B,l as x,y as M,z as T,A as U,f as E,F as H}from"./vendor.702b46c5.js";const O={name:"ChatHistory",components:{InfiniteLoading:$},data:()=>({client_id:"icyqwwpy744ugu5x4ymyt6jqrnpxso",global_twitch:{},global_bttv:{},channel_twitch_badges:{},channel_twitch_emotes:{},channel_cheers:{},channel_bttv:{},code:"",username:"",user_id:0,user_changed:!1,vod_filter:"",start_filter:"",end_filter:"",user_filter:"",message_filter:"",vods:[],infinite_id:0,selected_vod:0,filtered_vods:[],comment_cursor:"",comment_chunk_counter:0,comments:[],cancel_comment_fetch:!1,comment_fetch_in_progress:!1,select_size:window.innerHeight<800?0:20}),methods:{handleWindowResize(){this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(()=>{this.isMobile()?this.select_size=0:this.select_size=window.innerHeight<800?0:20},100)},isMobile(){return!!/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},formatDate(e){if(e)return g(String(e)).format("YYYY-MM-DD")},formatTime(e){if(e)return g(String(e)).format("hh:mm:ss A")},getColor(e){if(!e)return"hsl(264, 100%, 75%)";let t=V(e);return t.isDark()?t.brighten(25).toHexString():e},parseBits(e){for(let t of this.channel_cheers)if(e.toLowerCase().includes(t.prefix.toLowerCase())){let l=Number(e.substr(t.prefix.length));for(let n=t.tiers.length-1;n>=0;n--){let a=t.prefix+t.tiers[n].min_bits;if(l>=t.tiers[n].min_bits)return`<div class="inline"><img class="inline" src="${t.tiers[n].images.dark.animated["2"]}" alt="${a}" title="${a}" height="28" width="28"><span class="font-semibold" style="color: ${t.tiers[n].color}">${l}<span></div>`}}return e},parseBttv(e){if(this.isIterable(this.global_bttv)){for(let t of this.global_bttv)if(e===t.code)return`<img class="inline" src="https://cdn.betterttv.net/emote/${t.id}/2x" alt="${t.code}" title="${t.code}" height="28" width="28">`}if(this.isIterable(this.channel_bttv)){for(let t of this.channel_bttv)if(e===t.code)return`<img class="inline" src="https://cdn.betterttv.net/emote/${t.id}/2x" alt="${t.code}" title="${t.code}" height="28" width="28">`}return e},isIterable(e){return e==null?!1:typeof e[Symbol.iterator]=="function"},parseEmotes(e){for(let t of e.fragments)if(t.emoticon){if(t.emoticon.format="static",Object.keys(this.channel_twitch_emotes).length>0){let l=this.channel_twitch_emotes.find(n=>n.id===t.emoticon.emoticon_id);l&&l.format.length>1&&(t.emoticon.format="animated")}}else{let l=[];for(let n of t.text.split(" ")){let a=n;e.bits_spent&&(a=this.parseBits(n)),a=this.parseBttv(a),l.push(a)}t.text=l.join(" ")}return e.fragments},filterVods(e){this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(()=>{e.target.id==="vod-filter"?this.vod_filter=e.target.value:e.target.id==="start-time"?this.start_time=e.target.value:e.target.id==="end-time"&&(this.end_time=e.target.value),this.$refs.vodSelect[0].selected=!0,this.filtered_vods=this.vods.filter(this.compareVod)},200)},compareVod(e){return!(!e.title.toLowerCase().includes(this.vod_filter.toLowerCase())&&this.vod_filter!==""||g(e.created_at).isBefore(this.start_filter)&&this.start_filter!==""||g(e.created_at).isAfter(this.end_filter)&&this.end_filter!=="")},filterComments(e){this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout(()=>{e.target.id==="user-filter"?this.user_filter=e.target.value.trim():e.target.id==="message-filter"&&(this.message_filter=e.target.value),this.reloadComments()},500)},async loadComments(e){if(this.selected_vod===0){e.complete();return}if(this.comment_fetch_in_progress){for(this.cancel_comment_fect=!0;this.comment_fetch_in_progress;)await new Promise(o=>setTimeout(o,1e3));this.comments=[],this.comment_cursor="",this.comment_chunk_counter=0}const t={"Client-ID":this.client_id},l=`https://api.twitch.tv/v5/videos/${this.selected_vod}/comments`;var n=this.comment_cursor;this.comment_fetch_in_progress=!0;do{var a=n===null||n===""?`${l}?content_offset_seconds=0`:`${l}?cursor=${n}`;const o=await u.get(a,{headers:t});if(this.comments.push(...o.data.comments.filter(this.compareComment).map(d=>({created_at:d.created_at,username:d.commenter.name,displayname:d.commenter.display_name,user_badges:d.message.user_badges,body:d.message.body,fragments:d.message.fragments?this.parseEmotes(d.message):{},user_color:this.getColor(d.message.user_color),vod_link:`https://www.twitch.tv/videos/${this.selected_vod}?t=${Math.floor(d.content_offset_seconds/3600)}h${Math.floor(d.content_offset_seconds/60%60)}m${Math.floor(d.content_offset_seconds%60)}s`}))),!o.data._next){e.loaded(),e.complete();break}if(this.comments.length>this.comment_chunk_counter*500+500){this.comment_cursor=o.data._next,this.comment_chunk_counter+=1,e.loaded();break}n=o.data._next}while(n&&!this.cancel_comment_fect);this.comment_fetch_in_progress=!1,this.cancel_comment_fect=!1},compareComment(e){return!(!e.commenter.display_name.toLowerCase().includes(this.user_filter.toLowerCase())&&this.user_filter!==""||!e.message.body.toLowerCase().includes(this.message_filter.toLowerCase())&&this.message_filter!=="")},async getUserId(){const e={"Client-ID":this.client_id,Authorization:"Bearer "+this.code};return(await u.get(`https://api.twitch.tv/helix/users?login=${this.username}`,{headers:e})).data.data[0].id},async getVods(){let e=await this.getUserId();e!==this.user_id&&(this.user_id=e,this.user_changed=!0);var t="";this.vods=[],this.filtered_vods=[];do{const n={"Client-ID":this.client_id,Authorization:"Bearer "+this.code},a=await u.get(`https://api.twitch.tv/helix/videos?user_id=${this.user_id}&first=100&after=${t}`,{headers:n});var l=a.data.data.map(o=>({id:o.id,created_at:o.created_at,title:o.title}));if(this.vods.push(...l),this.filtered_vods.push(...l.filter(this.compareVod)),a.data.pagination.cursor)t=a.data.pagination.cursor;else break}while(t)},reloadComments(){if(this.comments=[],this.comment_cursor="",this.comment_chunk_counter=0,this.user_changed){u.get(`https://badges.twitch.tv/v1/badges/channels/${this.user_id}/display`).then(t=>{this.channel_twitch_badges=t.data.badge_sets});const e={"Client-ID":this.client_id,Authorization:"Bearer "+this.code};u.get(`https://api.twitch.tv/helix/chat/emotes?broadcaster_id=${this.user_id}`,{headers:e}).then(t=>{this.channel_twitch_emotes=t.data.data}),u.get(`https://api.twitch.tv/helix/bits/cheermotes?broadcaster_id=${this.user_id}`,{headers:e}).then(t=>{this.channel_cheers=t.data.data}),u.get(`https://api.betterttv.net/3/cached/users/twitch/${this.user_id}`).then(t=>{this.channel_bttv=t.data.channelEmotes,this.channel_bttv.push(...t.data.sharedEmotes)}),this.user_changed=!1}this.infinite_id+=1}},created:function(){const e=new URLSearchParams(window.location.search).get("code"),t=new URLSearchParams(window.location.hash.substr(1)).get("access_token");e?this.code=e:t&&(this.code=t),u.get("https://badges.twitch.tv/v1/badges/global/display").then(l=>{this.global_twitch=l.data.badge_sets}),u.get("https://api.betterttv.net/3/cached/emotes/global").then(l=>{this.global_bttv=l.data}),window.addEventListener("resize",this.handleWindowResize),this.handleWindowResize()},destroyed(){window.removeEventListener("resize",this.handleWindowResize)}},W=e=>(A("data-v-6e522f60"),e=e(),B(),e),j={class:"flex flex-wrap h-full w-full text-white p-2"},F={class:"flex flex-col h-1/3 w-full xl:w-1/3 xl:h-full border-gray-600 pb-2 xl:pb-0 xl:pr-2"},P={class:"flex flex-wrap gap-2 min-w-full"},R={class:"flex gap-2 min-w-full max-h-full pb-2"},N=["href"],Y={class:"text-xs md:text-base xl:text-lg"},q={class:"text-xs md:text-base xl:text-lg"},G=v("ALLOWED "),J=["disabled"],K={class:"text-xs md:text-base xl:text-lg"},Q=v("VODS "),X={class:"flex min-w-full"},Z=["disabled","size"],ee={ref:"defaultOption",value:"",disabled:"",hidden:"",selected:"",class:"rounded-sm even:bg-gray-800 w-full p-1 pl-3"},te=["value"],se={class:"flex flex-col h-2/3 w-full xl:w-2/3 xl:h-full"},ie={class:"flex w-full"},re={"infinite-wrapper":"",class:"h-full scrollbar-thin scrollbar-thumb-green-900 scrollbar-track-gray-500 scrollbar scrollbar-thumb-green-900 hover:scrollbar-thumb-green-800 scrollbar-track-gray-500 border-2 border-gray-600 bg-gray-900 rounded-b-md overflow-y-auto"},oe={class:"even:bg-gray-800 px-3 py-1 w-full"},ne=["href"],le={class:"inline text-center"},ae=["src","alt","title"],de=["src","alt","title"],he={key:2,class:"inline pr-1"},ce=["href"],ue=W(()=>r("span",{class:"inline"},": ",-1)),me={class:"inline text-center"},fe=["src","alt","title"],_e=["innerHTML"],ge=v("chat not loaded");function pe(e,t,l,n,a,o){const d=C("font-awesome-icon"),S=C("infinite-loading");return c(),h("div",j,[r("div",F,[r("div",P,[r("div",R,[r("a",{href:`https://id.twitch.tv/oauth2/authorize?response_type=token&client_id=${e.client_id}&redirect_uri=https://encrypted-thoughts.github.io/chat-history`,class:p([e.code?"":"animate-pulse","w-1/4 text-center bg-gray-900 border-2 border-gray-600 hover:bg-gray-700 font-bold py-2 px-1 shadow-lg rounded-md"])},[m(r("span",Y,"ALLOW ACCESS",512),[[k,!e.code]]),m(r("span",q,[G,y(d,{icon:"check",class:"text-green-600"})],512),[[k,e.code]])],10,N),m(r("input",{onInput:t[0]||(t[0]=s=>e.username=s.target.value.trim()),"onUpdate:modelValue":t[1]||(t[1]=s=>e.username=s),type:"text",class:"form-input border-2 border-gray-600 focus:outline-none focus:ring-0 focus:border-green-700 bg-gray-900 px-3 py-2 rounded-md w-2/4",placeholder:"Enter a username..."},null,544),[[_,e.username,void 0,{trim:!0}]]),r("button",{onClick:t[2]||(t[2]=s=>o.getVods()),disabled:!e.username||!e.code,class:"bg-gray-900 border-2 border-gray-600 hover:bg-gray-700 font-bold py-2 px-1 shadow-lg rounded-md w-1/4 disabled:opacity-50"},[r("span",K,[Q,y(d,{icon:"search"})])],8,J)])]),r("div",X,[m(r("input",{onInput:t[3]||(t[3]=s=>o.filterVods(s)),id:"vod-filter","onUpdate:modelValue":t[4]||(t[4]=s=>e.vod_filter=s),type:"text",class:"w-1/3 border-2 border-gray-600 focus:outline-none focus:ring-0 focus:border-green-700 form-input bg-gray-900 px-3 py-2 rounded-tl-md disabled:opacity-50",placeholder:"Filter on VOD name..."},null,544),[[_,e.vod_filter]]),m(r("input",{onInput:t[5]||(t[5]=s=>o.filterVods(s)),id:"start-time","onUpdate:modelValue":t[6]||(t[6]=s=>e.start_filter=s),type:"datetime-local",class:p([e.start_filter?"":"start-time","w-1/3 flex-1 border-2 border-gray-600 form-input focus:outline-none focus:ring-0 focus:border-green-700 bg-gray-900 px-3 py-2 disabled:opacity-50"]),placeholder:"Start time filter..."},null,34),[[_,e.start_filter]]),m(r("input",{onInput:t[7]||(t[7]=s=>o.filterVods(s)),id:"end-time","onUpdate:modelValue":t[8]||(t[8]=s=>e.end_filter=s),type:"datetime-local",class:p([e.end_filter?"":"end-time","w-1/3 flex-1 border-2 border-gray-600 form-input focus:outline-none focus:ring-0 focus:border-green-700 bg-gray-900 px-3 py-2 rounded-tr-md disabled:opacity-50"]),placeholder:"End time filter..."},null,34),[[_,e.end_filter]])]),m(r("select",{ref:"vodSelect",onChange:t[9]||(t[9]=(...s)=>o.reloadComments&&o.reloadComments(...s)),"onUpdate:modelValue":t[10]||(t[10]=s=>e.selected_vod=s),disabled:e.vods.length===0,size:e.select_size,class:p([e.select_size>0?"bg-none p-0":"","focus:outline-none focus:ring-0 focus:border-green-800 h-full w-full border-2 border-gray-600 bg-gray-900 rounded-b-md scrollbar-thin scrollbar-thumb-green-900 hover:scrollbar-thumb-green-800 scrollbar-track-gray-500 break-words whitespace-normal"])},[r("option",ee,"Select a vod...",512),(c(!0),h(b,null,w(e.filtered_vods,s=>(c(),h("option",{value:s.id,class:"rounded-sm even:bg-gray-800 w-full p-1 pl-3"},f(o.formatDate(s.created_at))+": "+f(s.title),9,te))),256))],42,Z),[[z,e.selected_vod]])]),r("div",se,[r("div",ie,[m(r("input",{onInput:t[11]||(t[11]=s=>o.filterComments(s)),id:"user-filter","onUpdate:modelValue":t[12]||(t[12]=s=>e.user_filter=s),type:"text",class:"w-1/2 form-input focus:outline-none focus:ring-0 focus:border-green-700 bg-gray-900 border-2 border-gray-600 rounded-tl-md",placeholder:"Filter on username..."},null,544),[[_,e.user_filter,void 0,{trim:!0}]]),m(r("input",{onInput:t[13]||(t[13]=s=>o.filterComments(s)),id:"message-filter","onUpdate:modelValue":t[14]||(t[14]=s=>e.message_filter=s),type:"text",class:"w-1/2 form-input focus:outline-none focus:ring-0 focus:border-green-700 bg-gray-900 border-2 border-gray-600 rounded-tr-md",placeholder:"Filter on message..."},null,544),[[_,e.message_filter]])]),r("div",re,[(c(!0),h(b,null,w(e.comments,s=>(c(),h("div",oe,[r("a",{class:"inline text-gray-400 pr-1",href:s.vod_link,target:"_blank",rel:"noopener noreferrer"},f(o.formatTime(s.created_at)),9,ne),(c(!0),h(b,null,w(s.user_badges,i=>(c(),h("div",le,[e.channel_twitch_badges[i._id]&&e.channel_twitch_badges[i._id].versions[i.version]?(c(),h("img",{key:0,class:"inline pr-1",src:e.channel_twitch_badges[i._id].versions[i.version].image_url_2x,alt:e.channel_twitch_badges[i._id].versions[i.version].title,title:e.channel_twitch_badges[i._id].versions[i.version].title,height:"28",width:"28"},null,8,ae)):e.global_twitch[i._id]&&e.global_twitch[i._id].versions[i.version]?(c(),h("img",{key:1,class:"inline pr-1",src:e.global_twitch[i._id].versions[i.version].image_url_2x,alt:e.global_twitch[i._id].versions[i.version].title,title:e.global_twitch[i._id].versions[i.version].title,height:"28",width:"28"},null,8,de)):(c(),h("span",he,f(i.title),1))]))),256)),r("a",{class:"inline",style:D({color:s.user_color}),href:`https://www.twitch.tv/${s.username}`,target:"_blank",rel:"noopener noreferrer"},f(s.displayname)+f(s.displayname.toLowerCase()===s.username.toLowerCase()?"":" ("+s.username+")"),13,ce),ue,(c(!0),h(b,null,w(s.fragments,i=>(c(),h("div",me,[i.emoticon?(c(),h("img",{key:0,class:"inline",src:`https://static-cdn.jtvnw.net/emoticons/v2/${i.emoticon.emoticon_id}/${i.emoticon.format}/dark/2.0`,alt:i.text,title:i.text,height:"28",width:"28"},null,8,fe)):(c(),h("div",{key:1,class:"inline text-white",innerHTML:i.text},null,8,_e))]))),256))]))),256)),y(S,{spinner:"2",forceUseInfiniteWrapper:"true",distance:200,identifier:e.infinite_id,onInfinite:o.loadComments,class:"even:bg-gray-800"},{"no-more":I(()=>[v("end of chat ("+f(this.comments.length)+" messages)",1)]),"no-results":I(()=>[ge]),_:1},8,["identifier","onInfinite"])])])])}var be=L(O,[["render",pe],["__scopeId","data-v-6e522f60"]]);x.add(M);x.add(T);x.add(U);E(be).component("font-awesome-icon",H).mount("#app");
